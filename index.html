<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì™„ë„ê³  í™˜ê²½ ì§€í‚´ì´ - íƒ„ì†Œì¤‘ë¦½ ì‹¤ì²œ í”„ë¡œì íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poor+Story&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Gaegu&display=swap");

      body {
        font-family: "Poor Story", "Gaegu", sans-serif;
        background-color: #f5f7f4;
        letter-spacing: -0.02em;
      }

      .title-font {
        font-family: "Gaegu", "Poor Story", sans-serif;
      }

      .eco-gradient {
        background: linear-gradient(120deg, #4ade80 0%, #60a5fa 100%);
      }

      .eco-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .eco-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          45deg,
          transparent 48%,
          rgba(255, 255, 255, 0.1) 50%,
          transparent 52%
        );
        transform: translateX(-100%);
        transition: transform 0.6s;
      }

      .eco-card:hover::before {
        transform: translateX(100%);
      }

      .eco-card:active {
        transform: scale(0.98);
      }
    </style>
  </head>
  <body class="bg-[#F5F7F4] pb-20">
    <!-- ìƒë‹¨ í—¤ë” -->
    <header
      class="bg-white/80 backdrop-blur-md shadow-sm fixed top-0 w-full z-10"
    >
      <div
        class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between"
      >
        <h1 class="text-2xl font-bold text-[#2F855A] title-font">
          ğŸŒ± ì™„ë„ê³  í™˜ê²½ ì§€í‚´ì´
        </h1>
        <a href="notification.html" class="p-2 relative">
          <i class="fas fa-bell text-[#2F855A]"></i>
          <span
            class="absolute top-1 right-1 bg-[#F59E0B] rounded-full w-2 h-2"
          ></span>
        </a>
      </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-7xl mx-auto pt-24 px-4 pb-4">
      <!-- ì§„í–‰ë¥  ì¹´ë“œ -->
      <div
        class="bg-white/80 backdrop-blur rounded-3xl p-6 mb-8 shadow-lg border border-green-100"
      >
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl text-[#2F855A] font-bold">ğŸŒ¿ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</h2>
          <button
            onclick="openProgressDetailModal()"
            class="text-lg text-[#4ADE80] font-bold hover:text-[#22C55E] transition-colors flex items-center"
          >
            <span id="progressText">75%</span>
            <i class="fas fa-chevron-right ml-1 text-sm"></i>
          </button>
        </div>
        <div class="relative">
          <div class="h-4 bg-gray-100 rounded-full">
            <div
              id="progressBar"
              class="absolute top-0 h-4 rounded-full eco-gradient"
              style="width: 75%"
            ></div>
          </div>
        </div>
      </div>

      <!-- í™œë™ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
      <div class="grid grid-cols-1 gap-5 md:grid-cols-3">
        <!-- ì¸ì¦í•˜ê¸° -->
        <div
          class="eco-card bg-white/80 backdrop-blur p-6 rounded-3xl shadow-lg border border-green-100"
        >
          <div
            class="bg-[#4ADE80]/10 w-14 h-14 rounded-2xl flex items-center justify-center mb-4"
          >
            <i class="fas fa-camera text-2xl text-[#4ADE80]"></i>
          </div>
          <h3 class="text-lg font-bold text-[#2F855A] mb-2">ì¸ì¦í•˜ê¸°</h3>
          <p class="text-sm text-gray-600">ì˜¤ëŠ˜ì˜ í™œë™ì„ ê¸°ë¡í•´ìš” ğŸ“¸</p>
        </div>

        <!-- íƒ„ì†Œì¤‘ë¦½ íŒ -->
        <div
          class="eco-card bg-white/80 backdrop-blur p-6 rounded-3xl shadow-lg border border-blue-100"
        >
          <div
            class="bg-[#60A5FA]/10 w-14 h-14 rounded-2xl flex items-center justify-center mb-4"
          >
            <i class="fas fa-leaf text-2xl text-[#60A5FA]"></i>
          </div>
          <h3 class="text-lg font-bold text-[#2563EB] mb-2">íƒ„ì†Œì¤‘ë¦½ íŒ</h3>
          <p class="text-sm text-gray-600">ì‹¤ì²œ ë°©ë²• ì•Œì•„ë³´ê¸° ğŸ’¡</p>
        </div>

        <!-- ì‹ë¬¼ í‚¤ìš°ê¸° íŒ -->
        <div
          class="eco-card bg-white/80 backdrop-blur p-6 rounded-3xl shadow-lg border border-purple-100"
        >
          <div
            class="bg-[#A78BFA]/10 w-14 h-14 rounded-2xl flex items-center justify-center mb-4"
          >
            <i class="fas fa-seedling text-2xl text-[#A78BFA]"></i>
          </div>
          <h3 class="text-lg font-bold text-[#7C3AED] mb-2">ì‹ë¬¼ í‚¤ìš°ê¸° íŒ</h3>
          <p class="text-sm text-gray-600">ë°˜ë ¤ì‹ë¬¼ ê´€ë¦¬ ë°©ë²• ğŸŒ±</p>
        </div>
      </div>
    </main>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav
      class="fixed bottom-0 w-full bg-white/80 backdrop-blur shadow-lg rounded-t-2xl border-t border-green-100"
    >
      <div class="flex justify-around items-center h-16 max-w-7xl mx-auto px-4">
        <a href="index.html" class="flex flex-col items-center text-[#2F855A]">
          <i class="fas fa-home text-xl mb-0.5"></i>
          <span class="text-xs">í™ˆ</span>
        </a>
        <a href="profile.html" class="flex flex-col items-center text-gray-400">
          <i class="fas fa-user text-xl mb-0.5"></i>
          <span class="text-xs">í”„ë¡œí•„</span>
        </a>
      </div>
    </nav>

    <!-- ëª¨ë‹¬ ì»¨í…Œì´ë„ˆë“¤ -->
    <!-- ì¸ì¦í•˜ê¸° ëª¨ë‹¬ -->
    <div
      id="certifyModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-3xl p-6 w-11/12 max-w-lg mx-4 relative max-h-[90vh] overflow-y-auto"
      >
        <button
          class="absolute top-4 right-4 text-gray-500 hover:text-gray-700"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
        <h2 class="text-2xl font-bold text-[#2F855A] mb-4">ğŸŒ± í™œë™ ì¸ì¦í•˜ê¸°</h2>

        <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ -->
        <div class="mb-6">
          <div id="imagePreview" class="hidden mb-4">
            <img
              src=""
              alt="ë¯¸ë¦¬ë³´ê¸°"
              class="w-full h-48 object-cover rounded-lg"
            />
            <button class="mt-2 text-red-500 text-sm" onclick="removeImage()">
              <i class="fas fa-trash mr-1"></i> ì´ë¯¸ì§€ ì œê±°
            </button>
          </div>

          <div
            id="uploadArea"
            class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-[#4ADE80] transition-colors"
          >
            <input
              type="file"
              id="imageInput"
              class="hidden"
              accept="image/*"
            />
            <i class="fas fa-camera text-3xl text-gray-400 mb-2"></i>
            <p class="text-sm text-gray-500">
              í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ ë˜ëŠ”<br />
              ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”
            </p>
          </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
        <h3 class="font-bold text-gray-700 mb-3">ì¹´í…Œê³ ë¦¬ ì„ íƒ</h3>
        <div class="grid grid-cols-2 gap-3 mb-6">
          <!-- ì¹´í…Œê³ ë¦¬ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ì„¤ëª… ì…ë ¥ -->
        <div class="mb-6">
          <label class="block font-bold text-gray-700 mb-2">í™œë™ ì„¤ëª…</label>
          <textarea
            id="activityDescription"
            class="w-full p-3 rounded-lg border border-gray-200 focus:border-[#4ADE80] focus:ring-1 focus:ring-[#4ADE80] outline-none resize-none"
            rows="3"
            placeholder="í™œë™ì— ëŒ€í•´ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­)"
          ></textarea>
        </div>

        <!-- ì œì¶œ ë²„íŠ¼ -->
        <button
          id="submitActivity"
          class="w-full py-3 rounded-lg bg-[#4ADE80] text-white font-bold hover:bg-[#22C55E] transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
          disabled
        >
          ì¸ì¦í•˜ê¸°
        </button>
      </div>
    </div>

    <!-- íƒ„ì†Œì¤‘ë¦½ íŒ ëª¨ë‹¬ -->
    <div
      id="carbonTipsModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-3xl p-6 w-11/12 max-w-2xl mx-4 relative max-h-[90vh] overflow-y-auto"
      >
        <button
          class="absolute top-4 right-4 text-gray-500 hover:text-gray-700"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
        <h2 class="text-2xl font-bold text-[#2563EB] mb-6">
          ğŸ’¡ íƒ„ì†Œì¤‘ë¦½ ì‹¤ì²œ íŒ
        </h2>
        <div class="space-y-6 tips-container">
          <!-- íŒ ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
        </div>
      </div>
    </div>

    <!-- ì‹ë¬¼ í‚¤ìš°ê¸° íŒ ëª¨ë‹¬ -->
    <div
      id="plantTipsModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-3xl p-6 w-11/12 max-w-lg mx-4 relative">
        <button
          class="absolute top-4 right-4 text-gray-500 hover:text-gray-700"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
        <h2 class="text-2xl font-bold text-[#7C3AED] mb-4">
          ğŸŒ± ì‹ë¬¼ í‚¤ìš°ê¸° íŒ
        </h2>
        <div class="space-y-4">
          <!-- íŒ ë‚´ìš©ì€ JavaScriptë¡œ ë™ì  ë¡œë“œ -->
        </div>
      </div>
    </div>

    <!-- ì§„í–‰ë¥  ìƒì„¸ ëª¨ë‹¬ ì¶”ê°€ -->
    <div
      id="progressDetailModal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-3xl p-6 w-11/12 max-w-lg mx-4 relative">
        <button
          class="absolute top-4 right-4 text-gray-500 hover:text-gray-700"
          onclick="closeProgressDetailModal()"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
        <h2 class="text-2xl font-bold text-[#2F855A] mb-6">ğŸŒ± ì§„í–‰ í˜„í™©</h2>

        <div class="space-y-6">
          <!-- ì§„í–‰ë¥  ë°” -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-gray-600">ì „ì²´ ì§„í–‰ë¥ </span>
              <span class="font-bold text-[#2F855A]" id="modalProgressText"
                >75%</span
              >
            </div>
            <div class="relative h-4 bg-gray-100 rounded-full">
              <div
                id="modalProgressBar"
                class="absolute top-0 h-4 rounded-full eco-gradient"
                style="width: 75%"
              ></div>
            </div>
          </div>

          <!-- ì˜¤ëŠ˜ì˜ í™œë™ -->
          <div class="bg-green-50 rounded-xl p-4">
            <h3 class="font-bold text-[#2F855A] mb-3">ì˜¤ëŠ˜ì˜ í™œë™</h3>
            <div class="space-y-2" id="todayStats">
              <div class="flex justify-between items-center">
                <span class="text-gray-600">ìŠ¹ì¸ëœ í™œë™</span>
                <span class="font-medium text-[#2F855A]">0ê°œ</span>
              </div>
            </div>
          </div>

          <!-- ì „ì²´ í†µê³„ -->
          <div class="bg-green-50 rounded-xl p-4">
            <h3 class="font-bold text-[#2F855A] mb-3">ì „ì²´ í†µê³„</h3>
            <div class="space-y-2" id="totalStats">
              <div class="flex justify-between items-center">
                <span class="text-gray-600">ì „ì²´ ê¸°ì—¬ë„</span>
                <span class="font-medium text-[#2F855A]">0%</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">ë‹¤ìŒ 1% ê¹Œì§€</span>
                <span class="font-medium text-[#2F855A]">3ê°œ</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");
        const notificationDot = document.querySelector(
          "[class*='bg-\\[#F59E0B\\]']"
        );

        // í† í° ì²´í¬ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        const token = localStorage.getItem("accessToken");

        if (token) {
          // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ
          await updateProgress();
          await checkNotifications();

          // 5ë¶„ë§ˆë‹¤ ì§„í–‰ë¥ ê³¼ ì•Œë¦¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          setInterval(async () => {
            await updateProgress();
            await checkNotifications();
          }, 300000);
        } else {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œ
          // ì§„í–‰ë¥  ì¹´ë“œ ìˆ¨ê¸°ê¸°
          const progressCard = document.querySelector("[class*='bg-white']");
          if (progressCard) {
            progressCard.style.display = "none";
          }
        }

        // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
        setupCardClickEvents();
      });

      // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      async function updateProgress() {
        try {
          const token = localStorage.getItem("accessToken");
          if (!token) {
            console.warn("í† í°ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const response = await fetch(
            "https://port-0-eco-guardian-backend-m53ifn0f2c0df751.sel4.cloudtype.app/api/progress",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            if (response.status === 401) {
              localStorage.removeItem("accessToken");
              window.location.href = "login.html";
              return;
            }
            throw new Error("ì§„í–‰ë¥  ì¡°íšŒ ì‹¤íŒ¨");
          }

          const data = await response.json();
          const progressBar = document.getElementById("progressBar");
          const progressText = document.getElementById("progressText");

          if (progressBar && progressText) {
            progressBar.style.width = `${data.percent}%`;
            progressText.textContent = `${data.percent}%`;

            // ì§„í–‰ë¥  ë°ì´í„°ë¥¼ localStorageì— ì €ì¥
            localStorage.setItem("progressData", JSON.stringify(data));

            if (data.percent >= 100) {
              progressBar.classList.add("bg-[#4ADE80]");
            }
          }
        } catch (err) {
          console.error("ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", err);
        }
      }

      // ì•Œë¦¼ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
      async function checkNotifications() {
        try {
          const token = localStorage.getItem("accessToken");
          if (!token) {
            return;
          }

          const response = await fetch(
            "https://port-0-eco-guardian-backend-m53ifn0f2c0df751.sel4.cloudtype.app/api/notifications",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("ì•Œë¦¼ ì¡°íšŒ ì‹¤íŒ¨");
          }

          const data = await response.json();
          const notificationDot = document.querySelector(
            "[class*='bg-\\[#F59E0B\\]']"
          );
          const notificationBadge = document.querySelector(
            "#notification-badge"
          );

          if (notificationDot) {
            notificationDot.style.display =
              data.unreadCount > 0 ? "block" : "none";
          }

          // ì•Œë¦¼ ê°œìˆ˜ í‘œì‹œ ë°°ì§€ ì¶”ê°€
          if (data.unreadCount > 0) {
            if (!notificationBadge) {
              const badge = document.createElement("span");
              badge.id = "notification-badge";
              badge.className =
                "absolute -top-1 -right-1 bg-[#F59E0B] text-white text-xs rounded-full w-4 h-4 flex items-center justify-center";
              badge.textContent = data.unreadCount;
              document
                .querySelector("a[href='notification.html']")
                .appendChild(badge);
            } else {
              notificationBadge.textContent = data.unreadCount;
            }
          } else if (notificationBadge) {
            notificationBadge.remove();
          }
        } catch (err) {
          console.error("ì•Œë¦¼ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", err);
        }
      }

      // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
      function openModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.body.style.overflow = "hidden";
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove("flex");
        modal.classList.add("hidden");
        document.body.style.overflow = "";
      }

      // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
      document.querySelectorAll(".fixed.inset-0 button").forEach((button) => {
        button.addEventListener("click", () => {
          const modal = button.closest(".fixed.inset-0");
          closeModal(modal.id);
        });
      });

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
      document.querySelectorAll(".fixed.inset-0").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            closeModal(modal.id);
          }
        });
      });

      // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì • í•¨ìˆ˜ ìˆ˜ì •
      function setupCardClickEvents() {
        // ì¸ì¦í•˜ê¸° ì¹´ë“œ
        document
          .querySelector(".eco-card:nth-child(1)")
          .addEventListener("click", () => {
            openCertifyModal();
          });

        // íƒ„ì†Œì¤‘ë¦½ íŒ ì¹´ë“œ
        document
          .querySelector(".eco-card:nth-child(2)")
          .addEventListener("click", () => {
            openModal("carbonTipsModal");
            loadCarbonTips();
          });

        // ì‹ë¬¼ í‚¤ìš°ê¸° íŒ ì¹´ë“œ
        document
          .querySelector(".eco-card:nth-child(3)")
          .addEventListener("click", () => {
            openModal("plantTipsModal");
            loadPlantTips();
          });
      }

      // íƒ„ì†Œì¤‘ë¦½ íŒ ë¡œë“œ í•¨ìˆ˜ ìˆ˜ì •
      async function loadCarbonTips() {
        try {
          const response = await fetch(
            "https://port-0-eco-guardian-backend-m53ifn0f2c0df751.sel4.cloudtype.app/api/tips?category=íƒ„ì†Œì¤‘ë¦½",
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
              },
            }
          );

          if (!response.ok) throw new Error("íŒ ë¡œë“œ ì‹¤íŒ¨");
          const data = await response.json();

          const tipsContainer = document.querySelector(
            "#carbonTipsModal .tips-container"
          );
          if (data.length === 0) {
            tipsContainer.innerHTML = `
              <div class="bg-blue-50 rounded-xl p-6">
                <p class="text-gray-600 text-center">ë“±ë¡ëœ íŒì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            `;
            return;
          }

          tipsContainer.innerHTML = data
            .sort((a, b) => a.order - b.order)
            .map(
              (tip) => `
              <div class="bg-blue-50 rounded-xl p-6">
                <h3 class="text-lg font-bold text-[#2563EB] mb-3">${
                  tip.title
                }</h3>
                <div class="prose prose-sm text-gray-600">
                  ${tip.content}
                </div>
                ${
                  tip.imageUrl
                    ? `
                  <img src="${tip.imageUrl}" alt="${tip.title}" class="mt-4 rounded-lg w-full object-cover h-48">
                `
                    : ""
                }
              </div>
            `
            )
            .join("");
        } catch (err) {
          console.error("íƒ„ì†Œì¤‘ë¦½ íŒ ë¡œë“œ ì‹¤íŒ¨:", err);
        }
      }

      // ì‹ë¬¼ ê´€ë¦¬ íŒ ë¡œë“œ í•¨ìˆ˜ ìˆ˜ì •
      async function loadPlantTips() {
        try {
          const response = await fetch(
            "https://port-0-eco-guardian-backend-m53ifn0f2c0df751.sel4.cloudtype.app/api/tips?category=ì‹ë¬¼ê´€ë¦¬",
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
              },
            }
          );

          if (!response.ok) throw new Error("íŒ ë¡œë“œ ì‹¤íŒ¨");
          const data = await response.json();

          const tipsContainer = document.querySelector(
            "#plantTipsModal .space-y-4"
          );
          if (data.length === 0) {
            tipsContainer.innerHTML = `
              <div class="bg-purple-50 rounded-xl p-4">
                <p class="text-gray-600 text-center">ë“±ë¡ëœ íŒì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            `;
            return;
          }

          tipsContainer.innerHTML = data
            .sort((a, b) => a.order - b.order)
            .map(
              (tip) => `
              <div class="bg-purple-50 rounded-xl p-4">
                <h3 class="font-bold text-[#7C3AED] mb-2">${tip.title}</h3>
                <p class="text-sm text-gray-600">${tip.content}</p>
                ${
                  tip.imageUrl
                    ? `
                  <img src="${tip.imageUrl}" alt="${tip.title}" class="mt-4 rounded-lg w-full object-cover h-40">
                `
                    : ""
                }
              </div>
            `
            )
            .join("");
        } catch (err) {
          console.error("ì‹ë¬¼ ê´€ë¦¬ íŒ ë¡œë“œ ì‹¤íŒ¨:", err);
        }
      }

      // ì¸ì¦í•˜ê¸° ëª¨ë‹¬ ê´€ë ¨ ì½”ë“œ ìˆ˜ì •
      function openCertifyModal() {
        const modal = document.getElementById("certifyModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.body.style.overflow = "hidden";

        // ëª¨ë‹¬ ì´ˆê¸°í™”
        const imagePreview = document.getElementById("imagePreview");
        const uploadArea = document.getElementById("uploadArea");
        const imageInput = document.getElementById("imageInput");
        const submitButton = document.getElementById("submitActivity");
        const descriptionInput = document.getElementById("activityDescription");

        imagePreview.classList.add("hidden");
        uploadArea.classList.remove("hidden");
        imageInput.value = "";
        descriptionInput.value = "";
        submitButton.disabled = true;

        // ì¹´í…Œê³ ë¦¬ ë¡œë“œ
        loadCategories();

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¤ì •
        setupImageUpload();
      }

      // ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤
      function setupImageUpload() {
        const uploadArea = document.getElementById("uploadArea");
        const imageInput = document.getElementById("imageInput");
        const imagePreview = document.getElementById("imagePreview");
        const submitButton = document.getElementById("submitActivity");

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.classList.add("border-[#4ADE80]");
        });

        uploadArea.addEventListener("dragleave", () => {
          uploadArea.classList.remove("border-[#4ADE80]");
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.classList.remove("border-[#4ADE80]");

          const file = e.dataTransfer.files[0];
          if (file && file.type.startsWith("image/")) {
            handleImageFile(file);
          }
        });

        // í´ë¦­ ì´ë²¤íŠ¸
        uploadArea.addEventListener("click", () => {
          imageInput.click();
        });

        imageInput.addEventListener("change", (e) => {
          if (e.target.files[0]) {
            handleImageFile(e.target.files[0]);
          }
        });
      }

      // ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
      function handleImageFile(file) {
        const reader = new FileReader();
        const imagePreview = document.getElementById("imagePreview");
        const uploadArea = document.getElementById("uploadArea");
        const img = imagePreview.querySelector("img");

        reader.onload = (e) => {
          img.src = e.target.result;
          imagePreview.classList.remove("hidden");
          uploadArea.classList.add("hidden");
          validateForm();
        };

        reader.readAsDataURL(file);
      }

      // ì´ë¯¸ì§€ ì œê±° í•¨ìˆ˜
      function removeImage() {
        const imagePreview = document.getElementById("imagePreview");
        const uploadArea = document.getElementById("uploadArea");
        const imageInput = document.getElementById("imageInput");

        imagePreview.classList.add("hidden");
        uploadArea.classList.remove("hidden");
        imageInput.value = "";
        validateForm();
      }

      // í¼ ìœ íš¨ì„± ê²€ì‚¬
      function validateForm() {
        const submitButton = document.getElementById("submitActivity");
        const hasImage = !document
          .getElementById("imagePreview")
          .classList.contains("hidden");
        const selectedCategory = document.querySelector(
          ".category-btn.selected"
        );

        submitButton.disabled = !(hasImage && selectedCategory);
      }

      // í™œë™ ì œì¶œ í•¨ìˆ˜
      async function submitActivity() {
        try {
          const selectedCategory = document.querySelector(
            ".category-btn.selected"
          );
          const imageInput = document.getElementById("imageInput");
          const description = document
            .getElementById("activityDescription")
            .value.trim();

          if (!selectedCategory || !imageInput.files[0]) {
            alert("ì¹´í…Œê³ ë¦¬ ì„ íƒê³¼ ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
            return;
          }

          // ë¡œë”© ìƒíƒœ í‘œì‹œ
          const submitButton = document.getElementById("submitActivity");
          const originalText = submitButton.textContent;
          submitButton.disabled = true;
          submitButton.textContent = "ì²˜ë¦¬ì¤‘...";

          // ì´ë¯¸ì§€ ì—…ë¡œë“œ
          const formData = new FormData();
          formData.append("image", imageInput.files[0]);

          const uploadResponse = await fetch(
            "https://port-0-eco-guardian-backend-m53ifn0f2c0df751.sel4.cloudtype.app/api/upload",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
              },
              body: formData,
            }
          );

          if (!uploadResponse.ok) {
            throw new Error("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }

          const { imageUrl } = await uploadResponse.json();

          // í™œë™ ë“±ë¡
          const activityResponse = await fetch(
            "https://port-0-eco-guardian-backend-m53ifn0f2c0df751.sel4.cloudtype.app/api/activities",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                category: selectedCategory.dataset.category,
                imageUrl,
                description,
              }),
            }
          );

          if (!activityResponse.ok) {
            throw new Error("í™œë™ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }

          const result = await activityResponse.json();
          alert(result.message);

          // ëª¨ë‹¬ ë‹«ê¸° ë° ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
          closeModal("certifyModal");
          updateProgress();
        } catch (err) {
          console.error("í™œë™ ë“±ë¡ ì‹¤íŒ¨:", err);
          alert(err.message || "í™œë™ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
          // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
          const submitButton = document.getElementById("submitActivity");
          submitButton.disabled = false;
          submitButton.textContent = "ì¸ì¦í•˜ê¸°";
        }
      }

      // ì§„í–‰ë¥  ìƒì„¸ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
      function openProgressDetailModal() {
        const modal = document.getElementById("progressDetailModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.body.style.overflow = "hidden";

        // ëª¨ë‹¬ ë‚´ ì§„í–‰ë¥  ì •ë³´ ì—…ë°ì´íŠ¸
        updateModalProgress();
      }

      function closeProgressDetailModal() {
        const modal = document.getElementById("progressDetailModal");
        modal.classList.remove("flex");
        modal.classList.add("hidden");
        document.body.style.overflow = "";
      }

      // ëª¨ë‹¬ ë‚´ ì§„í–‰ë¥  ì •ë³´ ì—…ë°ì´íŠ¸
      function updateModalProgress() {
        const data = JSON.parse(localStorage.getItem("progressData") || "{}");

        // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
        const modalProgressBar = document.getElementById("modalProgressBar");
        const modalProgressText = document.getElementById("modalProgressText");
        if (modalProgressBar && modalProgressText) {
          modalProgressBar.style.width = `${data.percent || 0}%`;
          modalProgressText.textContent = `${data.percent || 0}%`;
        }

        // ì˜¤ëŠ˜ì˜ í™œë™ ì—…ë°ì´íŠ¸
        const todayStats = document.getElementById("todayStats");
        if (todayStats) {
          todayStats.innerHTML = `
            <div class="flex justify-between items-center">
              <span class="text-gray-600">ìŠ¹ì¸ëœ í™œë™</span>
              <span class="font-medium text-[#2F855A]">${
                data.userContribution?.today || 0
              }ê°œ</span>
            </div>
          `;
        }

        // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
        const totalStats = document.getElementById("totalStats");
        if (totalStats) {
          totalStats.innerHTML = `
            <div class="flex justify-between items-center">
              <span class="text-gray-600">ì „ì²´ ê¸°ì—¬ë„</span>
              <span class="font-medium text-[#2F855A]">${
                data.userContribution?.percent || 0
              }%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">ë‹¤ìŒ 1% ê¹Œì§€</span>
              <span class="font-medium text-[#2F855A]">${
                data.remainingForNext || 0
              }ê°œ</span>
            </div>
          `;
        }
      }

      // ì¹´í…Œê³ ë¦¬ ë¡œë“œ ë° í‘œì‹œ í•¨ìˆ˜ ì¶”ê°€
      async function loadCategories() {
        try {
          const response = await fetch(
            "https://port-0-eco-guardian-backend-m53ifn0f2c0df751.sel4.cloudtype.app/api/categories",
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
              },
            }
          );

          if (!response.ok) throw new Error("ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨");
          const categories = await response.json();

          const categoryContainer = document.querySelector(".grid.grid-cols-2");
          if (categories.length === 0) {
            categoryContainer.innerHTML = `
              <p class="col-span-2 text-center text-gray-500">ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            `;
            return;
          }

          categoryContainer.innerHTML = categories
            .sort((a, b) => a.order - b.order)
            .map(
              (category) => `
              <button
                class="eco-card bg-white p-4 rounded-xl shadow border border-green-100 text-center category-btn"
                data-category="${category.code}"
              >
                <i class="fas ${getCategoryIcon(
                  category.code
                )} text-2xl text-[#4ADE80] mb-2"></i>
                <p class="text-sm">${category.name}</p>
              </button>
            `
            )
            .join("");

          // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          document.querySelectorAll(".category-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              document.querySelectorAll(".category-btn").forEach((b) => {
                b.classList.remove(
                  "selected",
                  "border-[#4ADE80]",
                  "bg-green-50"
                );
              });
              btn.classList.add("selected", "border-[#4ADE80]", "bg-green-50");
              validateForm();
            });
          });
        } catch (err) {
          console.error("ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:", err);
        }
      }

      // ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´ì½˜ ë§¤í•‘ í•¨ìˆ˜
      function getCategoryIcon(categoryCode) {
        const iconMap = {
          no_leftover: "fa-utensils",
          public_transport: "fa-bus",
          save_energy: "fa-lightbulb",
          // í•„ìš”í•œ ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜ ì¶”ê°€
        };
        return iconMap[categoryCode] || "fa-check"; // ê¸°ë³¸ ì•„ì´ì½˜
      }

      // ì œì¶œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document
        .getElementById("submitActivity")
        .addEventListener("click", submitActivity);
    </script>
  </body>
</html>
