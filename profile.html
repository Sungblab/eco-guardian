<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í”„ë¡œí•„ - ì™„ë„ê³  í™˜ê²½ ì§€í‚´ì´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poor+Story&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Gaegu&display=swap");

      body {
        font-family: "Poor Story", "Gaegu", sans-serif;
        background-color: #f5f7f4;
        letter-spacing: -0.02em;
      }

      .title-font {
        font-family: "Gaegu", "Poor Story", sans-serif;
      }

      .eco-gradient {
        background: linear-gradient(120deg, #4ade80 0%, #60a5fa 100%);
      }
    </style>
  </head>
  <body class="bg-[#F5F7F4]">
    <!-- ìƒë‹¨ í—¤ë” -->
    <header
      class="bg-white/80 backdrop-blur-md shadow-sm fixed top-0 w-full z-10"
    >
      <div
        class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between"
      >
        <h1 class="text-2xl font-bold text-[#2F855A] title-font">
          ğŸŒ± ì™„ë„ê³  í™˜ê²½ ì§€í‚´ì´
        </h1>
        <a href="notification.html" class="p-2 relative">
          <i class="fas fa-bell text-[#2F855A]"></i>
          <span
            class="absolute top-1 right-1 bg-[#F59E0B] rounded-full w-2 h-2 hidden"
          ></span>
        </a>
      </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="min-h-screen pt-24 px-4 pb-20">
      <div class="max-w-md mx-auto space-y-8">
        <!-- í”„ë¡œí•„ ì •ë³´ -->
        <div
          class="bg-white/80 backdrop-blur p-8 rounded-3xl shadow-lg border border-green-100 space-y-6"
        >
          <h2 class="text-xl font-bold text-[#2F855A]">ê¸°ë³¸ ì •ë³´</h2>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-gray-500">í•™ë²ˆ</label>
              <p id="studentId" class="text-lg font-bold text-gray-900"></p>
            </div>
            <div>
              <label class="text-sm text-gray-500">ì´ë¦„</label>
              <p id="studentName" class="text-lg font-bold text-gray-900"></p>
            </div>
            <div class="pt-2 grid grid-cols-2 gap-4">
              <a
                href="change-password.html"
                class="text-center text-sm py-2 px-3 rounded-lg bg-[#2F855A] text-white hover:bg-[#4ADE80] transition-colors"
              >
                ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
              </a>
              <button
                id="logoutBtn"
                class="w-full text-sm py-2 px-3 rounded-lg border border-red-500 text-red-500 hover:bg-red-50 transition-colors"
              >
                ë¡œê·¸ì•„ì›ƒ
              </button>
            </div>
          </div>
        </div>

        <!-- í™œë™ í†µê³„ -->
        <div
          class="bg-white/80 backdrop-blur p-8 rounded-3xl shadow-lg border border-green-100 space-y-6"
        >
          <h2 class="text-xl font-bold text-[#2F855A]">í™œë™ í†µê³„</h2>
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="text-sm text-gray-500">ì „ì²´ ì¸ì¦ íšŸìˆ˜</label>
              <p id="totalActivities" class="text-lg font-bold text-[#4ADE80]">
                0íšŒ
              </p>
            </div>
            <div>
              <label class="text-sm text-gray-500">ì—°ì† ì°¸ì—¬ì¼</label>
              <p id="streak" class="text-lg font-bold text-[#4ADE80]">0ì¼</p>
            </div>
          </div>
        </div>

        <!-- ìµœê·¼ í™œë™ -->
        <div
          class="bg-white/80 backdrop-blur p-8 rounded-3xl shadow-lg border border-green-100 space-y-6"
        >
          <h2 class="text-xl font-bold text-[#2F855A]">ìµœê·¼ í™œë™</h2>
          <ul id="recentActivities" class="space-y-4">
            <!-- ì—¬ê¸°ì— ìµœê·¼ í™œë™ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </ul>
        </div>
      </div>
    </main>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav
      class="fixed bottom-0 w-full bg-white/80 backdrop-blur shadow-lg rounded-t-2xl border-t border-green-100"
    >
      <div class="flex justify-around items-center h-16 max-w-7xl mx-auto px-4">
        <a href="index.html" class="flex flex-col items-center text-gray-400">
          <i class="fas fa-home text-xl mb-0.5"></i>
          <span class="text-xs">í™ˆ</span>
        </a>
        <a
          href="profile.html"
          class="flex flex-col items-center text-[#2F855A]"
        >
          <i class="fas fa-user text-xl mb-0.5"></i>
          <span class="text-xs">í”„ë¡œí•„</span>
        </a>
      </div>
    </nav>

    <script>
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ í™•ì¸ ë° í”„ë¡œí•„ ì •ë³´ ë¡œë“œ
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("accessToken");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        await Promise.all([loadUserStats(), checkNotifications()]);

        // 5ë¶„ë§ˆë‹¤ ì•Œë¦¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        setInterval(checkNotifications, 300000);
      });

      // ì‚¬ìš©ì í†µê³„ ë¡œë“œ
      async function loadUserStats() {
        try {
          const token = localStorage.getItem("accessToken");
          const [statsResponse, activitiesResponse] = await Promise.all([
            fetch("http://127.0.0.1:3000/api/users/stats/me", {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }),
            fetch("http://127.0.0.1:3000/api/activities?limit=5", {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }),
          ]);

          if (!statsResponse.ok || !activitiesResponse.ok) {
            if (
              statsResponse.status === 401 ||
              activitiesResponse.status === 401
            ) {
              localStorage.removeItem("accessToken");
              window.location.href = "login.html";
              return;
            }
            throw new Error("ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨");
          }

          const [statsData, activitiesData] = await Promise.all([
            statsResponse.json(),
            activitiesResponse.json(),
          ]);

          // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
          document.getElementById("studentId").textContent =
            statsData.user.studentId;
          document.getElementById("studentName").textContent =
            statsData.user.name;

          // í™œë™ í†µê³„ í‘œì‹œ
          document.getElementById(
            "totalActivities"
          ).textContent = `${statsData.personalStats.totalApproved}íšŒ`;
          document.getElementById(
            "streak"
          ).textContent = `${statsData.personalStats.streak}ì¼`;

          // ìµœê·¼ í™œë™ í‘œì‹œ
          const recentActivitiesList =
            document.getElementById("recentActivities");
          if (activitiesData.activities.length === 0) {
            recentActivitiesList.innerHTML = `
              <li class="text-center text-gray-500 py-4">
                ì•„ì§ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤
              </li>
            `;
          } else {
            recentActivitiesList.innerHTML = activitiesData.activities
              .map((activity) => createActivityItem(activity))
              .join("");
          }
        } catch (err) {
          console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
          if (err.message.includes("í† í°")) {
            window.location.href = "login.html";
          } else {
            alert("ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }

      // í™œë™ ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
      function getStatusText(status) {
        switch (status) {
          case "pending":
            return "ìŠ¹ì¸ ëŒ€ê¸°ì¤‘";
          case "approved":
            return "ìŠ¹ì¸ë¨";
          case "rejected":
            return "ê±°ì ˆë¨";
          default:
            return status;
        }
      }

      // í™œë™ ì•„ì´í…œ ìƒì„± í•¨ìˆ˜
      function createActivityItem(activity) {
        const statusColors = {
          pending: "text-yellow-600",
          approved: "text-green-600",
          rejected: "text-red-600",
        };

        return `
          <li class="p-4 bg-green-50/50 rounded-xl">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold text-[#2F855A]">${
                activity.category
              }</h3>
              <span class="text-sm ${
                statusColors[activity.status] || "text-gray-500"
              }">
                ${getStatusText(activity.status)}
              </span>
            </div>
            <p class="mt-2 text-sm text-gray-500">
              ${new Date(activity.createdAt).toLocaleDateString()}
            </p>
          </li>
        `;
      }

      // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ í•¨ìˆ˜ ìˆ˜ì •
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          try {
            const token = localStorage.getItem("accessToken");
            const refreshToken = localStorage.getItem("refreshToken");

            // ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­
            const response = await fetch(
              "http://127.0.0.1:3000/api/auth/logout",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ refreshToken }),
              }
            );

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í† í° ì‚­ì œ (ì‘ë‹µ ìƒíƒœì™€ ê´€ê³„ì—†ì´ ì‹¤í–‰)
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");

            // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = "login.html";
          } catch (err) {
            console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", err);
            // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ë¹„ìš°ê³  ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");
            window.location.href = "login.html";
          }
        });

      // ì•Œë¦¼ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
      async function checkNotifications() {
        try {
          const token = localStorage.getItem("accessToken");
          if (!token) {
            return;
          }

          const response = await fetch(
            "http://localhost:3000/api/notifications",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("ì•Œë¦¼ ì¡°íšŒ ì‹¤íŒ¨");
          }

          const data = await response.json();
          const notificationDot = document.querySelector(
            "[class*='bg-\\[#F59E0B\\]']"
          );
          const notificationBadge = document.querySelector(
            "#notification-badge"
          );

          if (notificationDot) {
            notificationDot.style.display =
              data.unreadCount > 0 ? "block" : "none";
          }

          // ì•Œë¦¼ ê°œìˆ˜ í‘œì‹œ ë°°ì§€ ì¶”ê°€
          if (data.unreadCount > 0) {
            if (!notificationBadge) {
              const badge = document.createElement("span");
              badge.id = "notification-badge";
              badge.className =
                "absolute -top-1 -right-1 bg-[#F59E0B] text-white text-xs rounded-full w-4 h-4 flex items-center justify-center";
              badge.textContent = data.unreadCount;
              document
                .querySelector("a[href='notification.html']")
                .appendChild(badge);
            } else {
              notificationBadge.textContent = data.unreadCount;
            }
          } else if (notificationBadge) {
            notificationBadge.remove();
          }
        } catch (err) {
          console.error("ì•Œë¦¼ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", err);
        }
      }
    </script>
  </body>
</html>
